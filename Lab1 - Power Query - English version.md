

In this Lab, we will import data from the Vélib APIs.

# Creation of Tables

Two URLs will be used to access this data:  
1. https://velib-metropole-opendata.smovengo.cloud/opendata/Velib_Metropole/station_information.json  
2. https://velib-metropole-opendata.smovengo.cloud/opendata/Velib_Metropole/station_status.json  

To import the data from these APIs, we will retrieve it via the Web Connector:  
1. _Get Data > More ... > Web > Connect_  
2. Paste the URL into the prompt  
3. Repeat the step in Power Query to obtain the two queries side by side  
4. Rename the two queries using the properties panel on the right OR by clicking on the Query name and using _"F2"_ or _Right-click > Rename_:  
   - station_status > Etats  
   - station_information > Stations  

# Optional: Parsing the JSON File  

## Stations  
1. Delete the steps generated by the Power Query engine on the right by removing them one by one  
2. Convert the document into an exploitable table  
3. _Click on the first column > Transform tab > Transpose rows into columns_  
4. Use the first row as headers  
5. Expand the data in the _Data_ column using the _Expand_ button next to the column name. Do not keep the column prefix.  
6. Expand the list of "stations" using the same button. By reviewing the station link (see part 1.1), decide whether the expansion should be done on the values or into new rows.  
7. After consideration, choose to expand into new rows.  
8. Expand the content of the Rows:  
   - Remove the prefix  
   - List all the available columns  

## Status  
1. Delete the steps generated by the Power Query engine on the right by removing them one by one  
2. Convert the document into an exploitable table  
3. _Click on the first column > Transform tab > Transpose rows into columns_  
4. Use the first row as headers  
5. Expand the data in the _Data_ column using the _Expand_ button next to the column name. Do not keep the column prefix.  
6. Expand the list of "stations" using the same button. By reviewing the station link (see part 1.1), decide whether the expansion should be done on the values or into new rows.  
7. After consideration, choose to expand into new rows.  
8. Expand the content of the Rows:  
   - Remove the prefix  
   - List all the available columns  
9. Process the column _num_bikes_available_types_:  
   - **Version 1:**  
     - Expand the column using the _Expand_ button into new rows.  
     - You will end up with two rows for each station. Expand them, then consolidate the results into one row.  
     - Expand the _Records_ into the _mechanical_ and _ebikes_ columns.  
     - Add a conditional column called _Available Bike Types_: If the _mechanical_ column is not _null_, then "mechanical," else "electric."  
     - Add a second conditional column called _Available Quantity_: If the _mechanical_ column is not _null_, use the value of the _mechanical_ column; otherwise, use the value of the _ebikes_ column. To do this, change the "ABC/123" icon to _Select A Column_.  
     - Remove the _mechanical_ and _ebikes_ columns.  
     - Click on the _Available Bikes Type_ column > Transform tab > Pivot > In the _Values Column_, choose _Available Quantity_.  

# Data Cleaning:  

## Stations  
1. Clean the data and prepare it for analysis in our report. Feel free to add additional steps as needed.  
2. Remove the _lastUpdatedOther_ and _ttl_ columns by selecting both (use _Ctrl + Click_), then _Right-click > Remove Columns_.  
3. By reviewing the _stations_status_ URL (see part 1.2), determine if the use of the _stationCode_ and _station_Id_ columns is relevant. Keep the more performant column.  
4. Rename the columns (deducing which one was removed in step 3):  
   - station_id > Station Id  
   - stationCode > Station Code  
   - name > Name  
   - lat > Latitude  
   - lon > Longitude  
   - capacity > Capacity  
5. Deduce the appropriate data types for each column based on its content. Optionally, use the _Detect data types_ feature.  

## Status  
1. Clean the data and prepare it for analysis in our report. Feel free to add additional steps as needed.  
2. Remove the _lastUpdatedOther_ and _ttl_ columns by selecting both (use _Ctrl + Click_), then _Right-click > Remove Columns_.  
3. Keep the most relevant column based on your logic from cleaning the station information.  
4. Remove duplicate columns from the table.  
5. Rename the columns:  
   - num_bikes_available or numBikesAvailable > Available Bikes  
   - num_docks_available or numDocksAvailable > Available Docks  
   - is_installed > Installed Flag  
   - is_returning > Returning Flag  
   - is_renting > Renting Flag  
   - last_reported > Last Reported Date  
6. Use the transformation/column addition feature of your choice to convert the "...Flag" columns into _true/false_ columns.  
7. Change the column type to _true/false_.  
8. Transform the _last_reported_ column into a _Datetime_ format.  

# General  

It is important to take a step back once all steps are applied. The order of the steps matters:  
- The more steps applied, the more critical their order becomes.  
- The most discriminating steps should be performed first, such as filters and column removals.  
- Steps that repeat can be unified and grouped (e.g., renaming all columns at once).  

The goal of this exercise is now to identify repetitive steps or those that could have been done earlier and reorganize them. You can reorder applied steps by dragging them. **Note:** If a step depends on another, plan accordingly.  
- Hint: The _lastUpdateOrder_ and _ttl_ columns could have been removed at the very beginning. Look for a way to remove them as early as possible.  

- Queries can be organized into folders: _Query > New Group > Drag queries into the appropriate groups._  

# Parameterizing Queries  

We will explore the use of parameters to simplify table evolution by replacing the fixed URL with a parameter.  
1. Create a new parameter called _URL_ using one of the following methods:  
   - Right-click under _Query > New Parameter..._  
   - _Home tab > Manage Parameter > New Parameter_  
2. Set the name to _URL_.  
3. Set the type to _Text_.  
4. Enter the common portion of the two URLs mentioned above into _Current Value_.  
5. For each _Stations_ and _Etat_ query, repeat the following steps:  
   - Click on the chosen _Query_.  
   - In the applied steps, find _Source_.  
   - In the formula bar, replace the fixed part with the _URL_ parameter, concatenating it with the rest using _URL & "string"_ (replace "string" with the correct value).  
   - Click on the last step and validate the development.  

# Applying Developments in Power BI  

Once the developments are complete, apply them in Power Query:  
1. In the _Home_ tab, click _Apply Changes_.  

# Date Table  

Using a date table is essential in a Power BI data model to leverage calendar intelligence and Power BI features. To do this, create a date reference table. This query should be set aside and reused in all Power BI models. Several methods exist to generate it; here’s one using Power Query:  
1. Create a new blank query: _Get Data > New Blank Query_.  
2. In the _Home_ tab, click _Advanced Editor_.  
3. Paste the following code and click _Apply_:  

   ```  
   let  
     StartDate = #date(2020,1,1),  
     EndDate = #date(2025,12,31),  
     Culture = "fr-fr",  
     DayCount = Duration.Days(Duration.From(EndDate - StartDate)) + 1,  
     Source = List.Dates(StartDate,DayCount,#duration(1,0,0,0)),  
     TableFromList = Table.FromList(Source, Splitter.SplitByNothing()),    
     ChangedType = Table.TransformColumnTypes(TableFromList,{{"Column1", type date}}),  
     RenamedColumns = Table.RenameColumns(ChangedType,{{"Column1", "Date"}}),  
     InsertYear = Table.AddColumn(RenamedColumns, "Year", each Date.Year([Date]), type number),  
     InsertQuarterKey = Table.AddColumn(InsertYear, "QuarterKey", each (([Year] * 10) + Date.QuarterOfYear([Date]))),  
     InsertQuarter = Table.AddColumn(InsertQuarterKey, "Quarter", each ("FY" & Number.ToText([Year]) & "-Q" & Number.ToText(Date.QuarterOfYear([Date]))), type text),  
     InsertMonthKey = Table.AddColumn(InsertQuarter, "MonthKey", each (([Year] * 100) + Date.Month([Date]))),  
     InsertMonth = Table

.AddColumn(InsertMonthKey, "Month", each (Number.ToText([Year]) & " - " & Date.ToText([Date], "MMM", Culture)), type text),  
     InsertDateKey = Table.AddColumn(InsertMonth, "DateKey", each (([Year] * 10000) + (Date.Month([Date])  
   ```
